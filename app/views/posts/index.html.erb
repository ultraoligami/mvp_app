<div class="container mt-5">
  <h1 class="mb-4">投稿一覧</h1>

  <% stamp_images = {
    "bikkuri" => "emoji_bikkuri.PNG",
    "sad"     => "emoji_sad.PNG",
    "good"    => "emoji_good.PNG",
    "hatena"  => "emoji_hatena.PNG"
  } %>

  <% stamps = [
    ["emoji_bikkuri.PNG", "bikkuri"],
    ["emoji_sad.PNG", "sad"],
    ["emoji_good.PNG", "good"],
    ["emoji_hatena.PNG", "hatena"]
  ] %>

  <% @posts.each do |post| %>
    <div class="card mb-3">
      <div class="card-body">

        <h4><%= link_to post.title, post_path(post) %></h4>
        <p class="text-muted">ジャンル：<%= post.category %></p>
        <p><%= truncate(post.content, length: 100) %></p>

        <p class="text-muted small">
          投稿者：
          <%= post.is_anonymous? ? "匿名さん" : post.user.nickname %>
        </p>

        <p class="text-muted small">
          <%= l post.created_at, format: :short %>
        </p>

        <% if user_signed_in? && post.user != current_user %>
          <% current_stamp = post.stamp_for(current_user) %>

          <div class="mt-2">

            <% if current_stamp.present? %>

              <% if current_stamp.user == current_user %>
                <!-- 自分が押した → 選択に戻す -->
                <div class="d-flex gap-2">
                  <% stamps.each do |img, type| %>
                    <%= form_with model: Stamp.new,
                                  url: post_stamps_path(post),
                                  method: :post do |f| %>
                      <%= f.hidden_field :stamp_type, value: type %>
                      <button class="stamp-btn">
                        <%= image_tag img, size: "40x40" %>
                      </button>
                    <% end %>
                  <% end %>
                </div>

              <% else %>
                <!-- 他人が押した → 表示のみ -->
                <%= image_tag stamp_images[current_stamp.stamp_type],
                              size: "40x40",
                              class: "stamp-current" %>
              <% end %>

            <% else %>
              <!-- 未スタンプ -->
              <div class="d-flex gap-2">
                <% stamps.each do |img, type| %>
                  <%= form_with model: Stamp.new,
                                url: post_stamps_path(post),
                                method: :post do |f| %>
                    <%= f.hidden_field :stamp_type, value: type %>
                    <button class="stamp-btn">
                      <%= image_tag img, size: "40x40" %>
                    </button>
                  <% end %>
                <% end %>
              </div>
            <% end %>

          </div>
        <% end %>

      </div>
    </div>
  <% end %>

  <% if user_signed_in? %>
    <%= link_to "新規投稿", new_post_path, class: "btn btn-success mt-3" %>
  <% end %>
</div>